<?php# Get all activity since this session's refresh time.# Set new refresh time.include('mysql.php');session_start();$Account = $_SESSION['AccountID'];$IP = $_SERVER['REMOTE_ADDR'];$Session = session_id();$Time = time();$FiveMinutesAgo = $Time - 300;if($_SESSION['Active'] > ($FiveMinutesAgo)){$Query = mysql_query("Select `ID`,`Active`,`Refresh`						from `Players`						where `Account`='$Account'");list($ID, $Active, $Refresh) = mysql_fetch_array($Query);if($ID){	$_SESSION['Active'] = $Active;	$Refresh -= 3;	$Activity = mysql_query("Select `ID`, `Account`, `Location`								from `Players`								where `ID` != '$ID'								and `Map`='{$_SESSION['Map']}'								and `Account` != '0'								order by `Active`								desc limit 10");		$Data = array();	while(list($PlayerID, $AccountID, $Location) = mysql_fetch_array($Activity))	{		$AccountQuery = mysql_query("Select `Character`, `Name`									from `Accounts`									where `ID`='$AccountID'");												list($CharacterID, $Name) = mysql_fetch_array($AccountQuery);			$CharacterQuery = mysql_query("Select `Image`										from `Characters`										where `ID`='$CharacterID'"); 												list($Image) = mysql_fetch_array($CharacterQuery);			$Data[$PlayerID] = array("name" => $Name,									"image" => $Image,									"location" => $Location);	}		echo json_encode($Data);	if($_SESSION['Name'])		mysql_query("Update `Players` set `Map`='{$_SESSION['Map']}', `Refresh`='$Time' where `ID`='$ID'");}else{	if($_SESSION['Name'])		mysql_query("Insert into `Players` values ('', '$Account', '$IP', '$Session', '{$_SESSION['Map']}', '50,50', '$Time', '0')");}}?>